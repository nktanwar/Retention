<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GATE CS ‚Äî Add Question</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; }
        .card { border-radius: 1rem; }
        h3.card-title { font-weight: 600; color: #0d6efd; }
        .chip {
          display: inline-flex;
          align-items: center;
          padding: 0.35rem 0.75rem;
          margin: 0.25rem;
          border-radius: 999px;
          background: #e9f2ff;
          color: #0d6efd;
          font-size: 0.9rem;
        }
        .chip button { border: 0; background: transparent; margin-left: 0.35rem; font-size: 1rem; color: #0d6efd; line-height: 1; }
        .option-row { display: flex; gap: 0.5rem; align-items: center; }
        .option-row input { flex: 1; }
        #jsonPreview { background: #1e1e1e; color: #dcdcdc; border-radius: 0.5rem; font-size: 0.85rem; }
        #status { font-weight: 500; }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="card shadow-lg">
        <div class="card-body p-4">
            <h3 class="card-title mb-3">‚ûï Add GATE CS Question</h3>
            <form id="questionForm" class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Subject</label>
                        <input id="subject" class="form-control" placeholder="e.g. Algorithms" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Difficulty</label>
                        <select id="difficulty" class="form-select" required>
                            <option value="">Choose difficulty</option>
                            <option>Easy</option><option>Medium</option><option>Hard</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Question Type</label>
                        <select id="questionType" class="form-select" required>
                            <option value="">Choose type</option>
                            <option value="MCQ">MCQ</option>
                            <option value="MSQ">MSQ</option>
                            <option value="NAT">NAT</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Marks</label>
                        <input type="number" id="marks" class="form-control" placeholder="e.g. 2" min="1">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label class="form-label">PYQ Appear Year<small>(optional)</small></label>
                        <input type="number" id="appearYear" class="form-control" placeholder="e.g. 2022" min="1990" max="2099">
                    </div>
                </div>

                <div class="mt-4 mb-3">
                    <label class="form-label">Question Text</label>
                    <textarea id="questionText" class="form-control" rows="4" placeholder="Type the question here..." required></textarea>
                </div>

                <!-- Options (only for MCQ/MSQ) -->
                <div class="mb-4" id="optionsBlock">
                    <label class="form-label">Options</label>
                    <div id="optionsList" class="mb-2"></div>
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" id="addOptionBtn" class="btn btn-outline-primary btn-sm">‚ûï Add option</button>
                        <button type="button" id="resetOptionsBtn" class="btn btn-outline-secondary btn-sm">Reset to 4</button>
                    </div>
                </div>

                <!-- Correct Answer -->
                <div class="mb-4" id="correctAnswerBlock"></div>

                <!-- Topics -->
                <div class="mb-4">
                    <label class="form-label">Topics</label>
                    <div class="d-flex gap-2 mb-2">
                        <input id="topicInput" class="form-control" placeholder="e.g. Dynamic Programming">
                        <button type="button" id="addTopicBtn" class="btn btn-outline-primary">Add</button>
                    </div>
                    <div id="topicsContainer"></div>
                </div>

                <!-- Subtopics -->
                <div class="mb-4">
                    <label class="form-label">Subtopics <small>(optional)</small></label>
                    <div class="d-flex gap-2 mb-2">
                        <input id="subtopicInput" class="form-control" placeholder="e.g. LIS">
                        <button type="button" id="addSubtopicBtn" class="btn btn-outline-primary">Add</button>
                    </div>
                    <div id="subtopicsContainer"></div>
                </div>

                <!-- Tags -->
                <div class="mb-4">
                    <label class="form-label">Tags <small>(optional)</small></label>
                    <div class="d-flex gap-2 mb-2">
                        <input id="tagInput" class="form-control" placeholder="e.g. DP, Graphs">
                        <button type="button" id="addTagBtn" class="btn btn-outline-primary">Add</button>
                    </div>
                    <div id="tagsContainer"></div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Image URL <small>(optional)</small></label>
                    <input type="url" id="imageUrl" class="form-control" placeholder="https://example.com/image.png" />
                </div>

                <div class="d-flex gap-2 align-items-center mb-3">
                    <button type="submit" class="btn btn-success">üíæ Save</button>
                    <button type="button" id="previewBtn" class="btn btn-outline-dark">üëÅ Preview JSON</button>
                    <div id="status" class="ms-3"></div>
                </div>

                <div id="jsonPreview" class="card p-3" style="display:none; white-space:pre-wrap; font-family:monospace; max-height:300px; overflow:auto"></div>
            </form>
        </div>
    </div>
</div>

<script>
    const optionsList = document.getElementById('optionsList');
    const correctAnswerBlock = document.getElementById('correctAnswerBlock');
    const topicsContainer = document.getElementById('topicsContainer');
    const subtopicsContainer = document.getElementById('subtopicsContainer');
    const tagsContainer = document.getElementById('tagsContainer');
    const status = document.getElementById('status');
    const jsonPreview = document.getElementById('jsonPreview');

    function createOptionRow(value = ''){
      const div = document.createElement('div');
      div.className = 'mb-2 option-row';
      const input = document.createElement('input');
      input.type = 'text'; input.className = 'form-control';
      input.placeholder = 'Option text'; input.value = value;
      input.required = true;
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button'; removeBtn.className = 'btn btn-outline-danger btn-sm';
      removeBtn.textContent = '‚úñ';
      removeBtn.onclick = () => { div.remove(); renderCorrectAnswerInputs(); };
      div.appendChild(input); div.appendChild(removeBtn);
      return div;
    }

    function resetOptions(){
      optionsList.innerHTML = '';
      for(let i=0;i<4;i++) optionsList.appendChild(createOptionRow(''));
      renderCorrectAnswerInputs();
    }

    function createChip(text, container){
      const span = document.createElement('span');
      span.className = 'chip'; span.textContent = text;
      const btn = document.createElement('button'); btn.type = 'button'; btn.innerHTML = '&times;';
      btn.onclick = () => span.remove(); span.appendChild(btn);
      container.appendChild(span);
    }

    function renderCorrectAnswerInputs(){
      const qType = document.getElementById('questionType').value;
      correctAnswerBlock.innerHTML = '';
      if(qType === 'MCQ'){
        const select = document.createElement('select');
        select.id = 'correctAnswer'; select.className = 'form-select';
        Array.from(optionsList.querySelectorAll('input')).forEach((inp, idx)=>{
          const opt = document.createElement('option');
          opt.value = inp.value || `Option ${idx+1}`;
          opt.textContent = inp.value || `Option ${idx+1}`;
          select.appendChild(opt);
        });
        correctAnswerBlock.appendChild(select);
      } else if(qType === 'MSQ'){
        correctAnswerBlock.innerHTML = '<label class="form-label">Select Correct Answers</label>';
        Array.from(optionsList.querySelectorAll('input')).forEach((inp, idx)=>{
          const div = document.createElement('div');
          div.className = 'form-check';
          const cb = document.createElement('input');
          cb.type = 'checkbox'; cb.className = 'form-check-input';
          cb.value = inp.value || `Option ${idx+1}`; cb.id = `cb${idx}`;
          const lbl = document.createElement('label');
          lbl.className = 'form-check-label'; lbl.htmlFor = `cb${idx}`;
          lbl.textContent = inp.value || `Option ${idx+1}`;
          div.appendChild(cb); div.appendChild(lbl);
          correctAnswerBlock.appendChild(div);
        });
      } else if(qType === 'NAT'){
        correctAnswerBlock.innerHTML = '<label class="form-label">Correct Answer (NAT)</label><input id="natAnswer" class="form-control" placeholder="Enter numeric/text answer">';
      }
    }

    function buildPayload(){
      const subject = document.getElementById('subject').value.trim();
      const difficulty = document.getElementById('difficulty').value;
      const questionType = document.getElementById('questionType').value;
      const questionText = document.getElementById('questionText').value.trim();
      const optionInputs = Array.from(optionsList.querySelectorAll('input'));
      const options = optionInputs.map(i=>i.value.trim()).filter(s=>s.length>0);
      let correctAnswer = [];
      if(questionType==='MCQ'){
        const sel = document.getElementById('correctAnswer');
        if(sel) correctAnswer = [sel.value];
      } else if(questionType==='MSQ'){
        correctAnswer = Array.from(correctAnswerBlock.querySelectorAll('input:checked')).map(cb=>cb.value);
      } else if(questionType==='NAT'){
        const natVal = document.getElementById('natAnswer').value.trim();
        if(natVal) correctAnswer = [natVal];
      }
      const topics = Array.from(topicsContainer.querySelectorAll('.chip')).map(c=>c.firstChild.textContent);
      const subtopics = Array.from(subtopicsContainer.querySelectorAll('.chip')).map(c=>c.firstChild.textContent);
      const tags = Array.from(tagsContainer.querySelectorAll('.chip')).map(c=>c.firstChild.textContent);
      const imageUrl = document.getElementById('imageUrl').value.trim() || null;
      const marks = parseInt(document.getElementById('marks').value) || null;
      const appearYear = parseInt(document.getElementById('appearYear').value) || null;

      return { subject, questionText, options, correctAnswer, difficulty, topic: topics,
        subTopic: subtopics.length ? subtopics : null, tags: tags.length ? tags : null,
        imageUrl, questionType, marks, appearYear };
    }

    document.getElementById('questionForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = buildPayload();
      status.innerHTML = '<span class="text-muted">Saving‚Ä¶</span>';
      try{
        const resp = await fetch('http://localhost:8080/questions/add', {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        if(resp.ok){ status.innerHTML='<span class="text-success">‚úÖ Saved!</span>'; resetOptions(); }
        else status.innerHTML='<span class="text-danger">Save failed</span>';
      }catch(err){ status.innerHTML=`<span class="text-danger">Network error: ${err.message}</span>`; }
    });

    document.getElementById('questionType').addEventListener('change', renderCorrectAnswerInputs);
    document.getElementById('addOptionBtn').addEventListener('click', ()=>{ optionsList.appendChild(createOptionRow('')); renderCorrectAnswerInputs(); });
    document.getElementById('resetOptionsBtn').addEventListener('click', resetOptions);
    document.getElementById('addTopicBtn').addEventListener('click', ()=>{ const v=document.getElementById('topicInput').value.trim(); if(v) createChip(v,topicsContainer); document.getElementById('topicInput').value=''; });
    document.getElementById('addSubtopicBtn').addEventListener('click', ()=>{ const v=document.getElementById('subtopicInput').value.trim(); if(v) createChip(v,subtopicsContainer); document.getElementById('subtopicInput').value=''; });
    document.getElementById('addTagBtn').addEventListener('click', ()=>{ const v=document.getElementById('tagInput').value.trim(); if(v) createChip(v,tagsContainer); document.getElementById('tagInput').value=''; });
    document.getElementById('previewBtn').addEventListener('click', ()=>{ jsonPreview.style.display=jsonPreview.style.display==='none'?'block':'none'; if(jsonPreview.style.display==='block') jsonPreview.textContent=JSON.stringify(buildPayload(),null,2); });

    resetOptions();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
